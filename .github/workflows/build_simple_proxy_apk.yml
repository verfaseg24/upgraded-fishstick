# Build APKs for Kiwi Browser with Proxy Support
name: 'Build APK with Proxy Support'

# This workflow uses Kiwi's existing build infrastructure
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify proxy files exist
        run: |
          echo "ðŸ” Checking proxy implementation files..."
          
          # Check Java files
          if [ -f "chrome/android/java/src/org/chromium/chrome/browser/proxy/ProxyConfig.java" ]; then
            echo "âœ… ProxyConfig.java found"
          else
            echo "âŒ ProxyConfig.java not found"
            exit 1
          fi
          
          if [ -f "chrome/android/java/src/org/chromium/chrome/browser/proxy/ProxyManager.java" ]; then
            echo "âœ… ProxyManager.java found"
          else
            echo "âŒ ProxyManager.java not found"
            exit 1
          fi
          
          if [ -f "chrome/android/java/src/org/chromium/chrome/browser/proxy/ProxyFetcher.java" ]; then
            echo "âœ… ProxyFetcher.java found (Auto-proxy support)"
          else
            echo "âš ï¸ ProxyFetcher.java not found (Auto-proxy disabled)"
          fi
          
          # Check C++ files
          if [ -f "chrome/browser/proxy/proxy_manager_android.cc" ]; then
            echo "âœ… proxy_manager_android.cc found"
          else
            echo "âŒ proxy_manager_android.cc not found"
            exit 1
          fi
          
          # Check layouts
          if [ -f "chrome/android/java/res/layout/activity_proxy_settings.xml" ]; then
            echo "âœ… activity_proxy_settings.xml found"
          else
            echo "âŒ activity_proxy_settings.xml not found"
            exit 1
          fi
          
          echo ""
          echo "âœ… All proxy files verified!"

      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v4.8

      - name: Trigger Kiwi build server
        id: trigger_build
        run: |
          echo "ðŸš€ Attempting to trigger Kiwi build server..."
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ steps.branch-name.outputs.current_branch }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          
          if [ -z "${{ secrets.BUILD_KEY }}" ]; then
            echo "âŒ BUILD_KEY not configured"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âš ï¸  KIWI BUILD SERVER NOT AVAILABLE"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "GitHub Actions cannot build Chromium (requires 4+ hours and 100GB+ disk)."
            echo ""
            echo "ðŸ“‹ RECOMMENDED SOLUTION: Build locally"
            echo ""
            echo "1. Install dependencies:"
            echo "   sudo apt-get install python3 openjdk-11-jdk git"
            echo ""
            echo "2. Setup depot_tools:"
            echo "   git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git"
            echo "   export PATH=\"\$PATH:\$HOME/depot_tools\""
            echo ""
            echo "3. Setup Android SDK (see BUILD_APK_GUIDE.md)"
            echo ""
            echo "4. Build:"
            echo "   gn gen out/Default"
            echo "   autoninja -C out/Default chrome_public_apk"
            echo ""
            echo "ðŸ“š Full guide: BUILD_APK_GUIDE.md"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "build_triggered=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âœ… BUILD_KEY found, triggering build..."
            curl --http1.0 --no-buffer -s \
              "http://longbuild.find.kiwi/build_apk.php?build_key=${{ secrets.BUILD_KEY }}&git_user=${{ github.repository_owner }}&git_repository=${{ github.event.repository.name }}&git_runid=${{ github.run_id }}&git_branch=${{ steps.branch-name.outputs.current_branch }}"
            echo ""
            echo "build_triggered=true" >> $GITHUB_OUTPUT
          fi

      - name: Build summary
        run: |
          echo "## Build Status ðŸ“±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.trigger_build.outputs.build_triggered }}" == "true" ]; then
            echo "âœ… Build triggered on Kiwi infrastructure" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Download link (available in 30-60 minutes):**" >> $GITHUB_STEP_SUMMARY
            echo "https://build.find.kiwi/apks/${{ github.run_id }}/out.apk" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Kiwi build server not available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Build Locally Instead" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "GitHub Actions cannot build Chromium (too resource intensive)." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Follow these steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Clone repository locally" >> $GITHUB_STEP_SUMMARY
            echo "2. Install dependencies (see BUILD_APK_GUIDE.md)" >> $GITHUB_STEP_SUMMARY
            echo "3. Run: \`gn gen out/Default && autoninja -C out/Default chrome_public_apk\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Requirements:**" >> $GITHUB_STEP_SUMMARY
            echo "- Linux or macOS" >> $GITHUB_STEP_SUMMARY
            echo "- 16+ GB RAM" >> $GITHUB_STEP_SUMMARY
            echo "- 100+ GB disk space" >> $GITHUB_STEP_SUMMARY
            echo "- 2-4 hours build time" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Proxy Features Included:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTTP/HTTPS Proxy" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… SOCKS4/SOCKS5 Proxy" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auto Proxy (Free proxies from API)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Proxy Authentication" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Settings UI" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Proxy Testing" >> $GITHUB_STEP_SUMMARY

